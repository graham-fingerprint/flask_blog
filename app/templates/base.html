<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ title or "My Blog" }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  <script>
  window.FP_PUBLIC_KEY = "{{ FP_PUBLIC_KEY }}";
  window.FP_REGION = "{{ FP_REGION }}";
</script>

<!-- Load FingerprintJS agent early and expose a shared promise -->
<script type="module">
  (async () => {
    if (!window.FP_PUBLIC_KEY) {
      console.warn("Fingerprint public key missing");
      window.fpPromise = null;
      return;
    }
    try {
      const { load } = await import(`https://fpjscdn.net/v3/${window.FP_PUBLIC_KEY}`);
      const opts = {};
      if (window.FP_REGION === 'eu' || window.FP_REGION === 'ap') {
        opts.region = window.FP_REGION;   // âœ… only valid regions
      }
      window.fpPromise = load(opts);
    } catch (e) {
      console.warn("Failed to load Fingerprint agent:", e);
      window.fpPromise = null;
    }
  })();
</script>

</head>
<body>
  <header>
    <h1><a href="{{ url_for('main.index') }}">My Blog</a></h1>
    <nav>
      {% if current_user.is_authenticated %}
        <span>Hi {{ current_user.username }}</span>
        <a href="{{ url_for('main.create_post') }}">New Post</a>
        <a href="{{ url_for('auth.logout') }}">Logout</a>
      {% else %}
        <a href="{{ url_for('auth.login') }}">Login</a>
        <a href="{{ url_for('auth.register') }}">Register</a>
      {% endif %}
    </nav>
  </header>
  <main>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <ul class="flashes">
        {% for category, msg in messages %}
          <li class="{{ category }}">{{ msg }}</li>
        {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>
<!--
<script>
  // Read keys from Flask config
 const FP_PUBLIC_KEY = "{{ FP_PUBLIC_KEY }}";
  const FP_REGION = "{{ FP_REGION }}";

  // Prepare a promise to load the agent once for use on registration
  let fpPromise = null;
  if (FP_PUBLIC_KEY) {
    fpPromise = import('https://fpjscdn.net/v3/v9PsghOuL6bPysSyN4q2')
      .then(FingerprintJS => {
        const opts = {};
        if (FP_REGION) opts.region = FP_REGION;
        return FingerprintJS.load();
      })
      .catch(err => {
        console.warn("Fingerprint agent failed to load", err);
        return null; // keep going even if FP fails
      });
  }
</script>
-->
</body>
</html>
