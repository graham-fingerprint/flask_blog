{% extends "base.html" %}
{% block content %}
  <h2>Register</h2>
  <form id="registerForm" method="post">
    <label>Username: <input name="username" required></label><br>
    <label>Email: <input name="email" type="email" required></label><br>
    <label>Password: <input type="password" name="password" required></label><br>

<!-- Hidden fields populated by Fingerprint just before submit -->
    <input type="hidden" name="fp_visitorId">
    <input type="hidden" name="fp_requestId">
    <input type="hidden" name="fp_confidence">

    <button id="registerBtn" type="submit">Register</button>
  </form>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById('registerForm');
    const btn = document.getElementById('registerBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      btn.disabled = true;
      try {
        if (window.fpPromise) {
          const fp = await window.fpPromise;
          if (fp) {
            const result = await fp.get({ extendedResult: true, linkedId: "registration" });
            form.elements['fp_visitorId'].value = result.visitorId || "";
            form.elements['fp_requestId'].value = result.requestId || "";
            form.elements['fp_confidence'].value = (result.confidence && result.confidence.score) || "";
            console.log("FP OK:", result.visitorId, result.requestId, result.confidence?.score);
          } else {
            console.warn("fpPromise is null");
          }
        } else {
          console.warn("fpPromise is undefined");
        }
      } catch (err) {
        console.warn("Fingerprint get() failed:", err);
      } finally {
        form.submit();
      }
    });
  });
</script>  
{% endblock %}
